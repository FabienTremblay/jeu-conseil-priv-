# docker-compose.dev.yml — version minimal fiable
# (pas de profiles; indentation 2 espaces; labels Traefik avec valeur par défaut)

x-common-env: &common_env
  PROJET_NOM: ${PROJET_NOM:-jeu-aventure}
  DOMAIN_LOCAL: ${DOMAIN_LOCAL:-jeu.localhost}
  API_PORT: ${API_PORT:-8080}
  API_WORKERS: ${API_WORKERS:-2}
  POSTGRES_DB: ${POSTGRES_DB:-jeu}
  POSTGRES_USER: ${POSTGRES_USER:-jeu}
  POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme}
  REDIS_URL: ${REDIS_URL:-redis://redis:6379/0}
  PYTHONDONTWRITEBYTECODE: "1"

networks:
  appnet:

volumes:
  pgdata:
  redisdata:
  api-venv:
  api-pip-cache:
  worker-venv:
  worker-pip-cache:
  monitor-node-mod:
  app-joueurs-node-mod:

services:
  traefik:
    image: traefik:v3.1
    command:
      - --providers.docker=true
      - --entrypoints.web.address=:80
      - --api.dashboard=true
    ports:
      - "80:80"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    labels:
      - traefik.enable=true
      - traefik.http.routers.traefik.rule=Host(`${DOMAIN_LOCAL:-jeu.localhost}`) && PathPrefix(`/traefik`)
      - traefik.http.routers.traefik.service=api@internal
    networks: [appnet]

  postgres:
    image: postgres:16
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-jeu}
      POSTGRES_USER: ${POSTGRES_USER:-jeu}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme}
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER"]
      interval: 5s
      timeout: 5s
      retries: 20
    networks: [appnet]

  redis:
    image: redis:7-alpine
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - redisdata:/data
    networks: [appnet]

  api:
    image: python:3.11-slim
    working_dir: /app
    env_file:
      - ../../env/dev/.env
    environment:
      <<: *common_env
      UVICORN_RELOAD_DIRS: /app
      REGLES_PATH: /data/docs/regles/exemple.yaml
    volumes:
      - ../../packages/api:/app:rw
      - ../../docs:/data/docs:ro
      - api-venv:/venv
      - api-pip-cache:/root/.cache/pip
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
    command: |
      bash -lc '
        set -e
        apt-get update -qq
        DEBIAN_FRONTEND=noninteractive apt-get install -y -qq python3-venv curl
        rm -rf /var/lib/apt/lists/*
        python -V
        if [ ! -x /venv/bin/python ]; then python -m venv /venv; fi
        . /venv/bin/activate
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        else
          pip install "fastapi>=0.115" "uvicorn[standard]>=0.30"
        fi
        exec uvicorn api.main:app --host 0.0.0.0 --port ${API_PORT:-8080} --reload
      '
    labels:
      - traefik.enable=true
      - traefik.http.routers.api.rule=Host(`${DOMAIN_LOCAL:-jeu.localhost}`) && PathPrefix(`/api`)
      - traefik.http.services.api.loadbalancer.server.port=${API_PORT:-8080}
    networks: [appnet]

  worker:
    image: python:3.11-slim
    working_dir: /app
    env_file:
      - ../../env/dev/.env
    environment:
      <<: *common_env
    volumes:
      - ../../packages/worker:/app:rw
      - worker-venv:/venv
      - worker-pip-cache:/root/.cache/pip
    depends_on:
      - redis
      - api
    command: |
      bash -lc '
        set -e
        apt-get update -qq
        DEBIAN_FRONTEND=noninteractive apt-get install -y -qq python3-venv
        rm -rf /var/lib/apt/lists/*
        python -V
        if [ ! -x /venv/bin/python ]; then python -m venv /venv; fi
        . /venv/bin/activate
        if [ -f requirements.txt ]; then pip install -r requirements.txt; else pip install redis rq; fi
        python -c "print(\"worker prêt — configure la commande réelle\")"
        exec tail -f /dev/null
      '
    networks: [appnet]

  monitor-web:
    image: node:20-alpine
    working_dir: /app
    env_file:
      - ../../env/dev/.env
    environment:
      NEXT_PUBLIC_API_BASE: http://${DOMAIN_LOCAL:-jeu.localhost}/api
    volumes:
      - ../../packages/monitor-web:/app:rw
      - monitor-node-mod:/app/node_modules
    depends_on:
      - api
    command: >
      sh -lc "
        [ -f package.json ] || (echo '{\"name\":\"monitor-web\",\"private\":true,\"version\":\"0.0.0\",\"scripts\":{\"dev\":\"next dev -H 0.0.0.0 -p 3000\"},\"dependencies\":{\"next\":\"14.2.5\",\"react\":\"18.2.0\",\"react-dom\":\"18.2.0\"}}' > package.json &&
        mkdir -p src/pages &&
        echo 'export default function H(){return (<main style={{padding:24}}><h1>Moniteur</h1><p>API: {process.env.NEXT_PUBLIC_API_BASE}</p></main>);}' > src/pages/index.tsx ) &&
        npm install --no-audit --no-fund &&
        npm run dev
      "
    labels:
      - traefik.enable=true
      - traefik.http.routers.monitor.rule=Host(`${DOMAIN_LOCAL:-jeu.localhost}`)
      - traefik.http.services.monitor.loadbalancer.server.port=3000
    networks: [appnet]

  app-joueurs:
    image: node:20-alpine
    working_dir: /app
    env_file:
      - ../../env/dev/.env
    environment:
      NEXT_PUBLIC_API_BASE: http://${DOMAIN_LOCAL:-jeu.localhost}/api
    volumes:
      - ../../packages/app-joueurs:/app:rw
      - app-joueurs-node-mod:/app/node_modules
    depends_on:
      - api
    command: >
      sh -lc "
        [ -f package.json ] || (echo '{\"name\":\"app-joueurs\",\"private\":true,\"version\":\"0.0.0\",\"scripts\":{\"dev\":\"next dev -H 0.0.0.0 -p 3001\"},\"dependencies\":{\"next\":\"14.2.5\",\"react\":\"18.2.0\",\"react-dom\":\"18.2.0\"}}' > package.json &&
        mkdir -p src/pages &&
        echo 'export default function H(){return (<main style={{padding:24}}><h1>App joueurs</h1><p>API: {process.env.NEXT_PUBLIC_API_BASE}</p></main>);}' > src/pages/index.tsx ) &&
        npm install --no-audit --no-fund &&
        npm run dev
      "
    labels:
      - traefik.enable=true
      - traefik.http.routers.app_joueurs.entrypoints=web
      - traefik.http.routers.app_joueurs.rule=Host(`mobile.${DOMAIN_LOCAL:-jeu.localhost}`)
      - traefik.http.services.app_joueurs.loadbalancer.server.port=3001
    networks: [appnet]
